<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>codetbase - 강화</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --main-dark: #2c3e50; }
        body { background: #e6e9ed; font-family: sans-serif; display: flex; justify-content: center; margin: 0; padding: 20px 0; }
        .game-container { width: 100%; max-width: 420px; background: white; border-radius: 30px; overflow: hidden; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .header { background: var(--main-dark); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .npc-box { background: #f8f9fa; border: 1px solid #ddd; border-radius: 15px; margin: 15px; padding: 15px; }
        .img-box { background: #eee; height: 250px; display: flex; align-items: center; justify-content: center; margin: 0 15px; border-radius: 20px; }
        .sword-img { max-width: 85%; max-height: 85%; object-fit: contain; }
        .btn-group { display: flex; gap: 10px; padding: 15px; }
        button { flex: 1; padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }
        .money-eff { position: absolute; right: 20px; top: 10px; font-weight: bold; animation: float 2.5s forwards; }
        @keyframes float { 0% { opacity:0; transform:translateY(0); } 20% { opacity:1; } 100% { opacity:0; transform:translateY(-100px); } }
    </style>
</head>
<body>
<div id="loading">데이터 로딩 중...</div>
<div class="game-container" id="game-ui">
    <div class="header">
        <span id="nick-display" style="color:#f1c40f; font-weight:bold;">로딩중...님</span>
        <div style="display:flex; gap:10px; align-items:center;">
            <button onclick="redeem()" style="background:#f1c40f; color:#333; padding:5px 10px; font-size:12px; height:auto;">보상코드</button>
            <div id="gold-anchor" style="position:relative;"><span id="gold-display" style="font-weight:bold;">0G</span></div>
        </div>
    </div>
    <div class="npc-box">
        <b style="color:#c0392b; display:block; margin-bottom:5px;">대장장이 루돌프</b>
        <div id="npc-msg">"반갑네! 무엇을 강화하러 왔나?"</div>
    </div>
    <div class="img-box"><img id="sword-img" src="" class="sword-img"></div>
    <div style="padding:15px;">
        <div id="sw-name" style="font-size:18px; font-weight:bold;">아이템 이름</div>
        <div id="cost-info" style="font-size:13px; color:#888; margin-top:5px;">비용: 0G | 확률: 0%</div>
    </div>
    <div class="btn-group">
        <button onclick="handleSell()" style="background:#f1f2f6; color:#999;">판매</button>
        <button onclick="handleUpgrade()" style="background:var(--main-dark); color:white;">강화하기</button>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let user = null, swords = {};

    async function init() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) { location.href="login.html"; return; }
        
        // 1. 아이템 데이터 로드
        const { data: s } = await supabaseClient.from('sword_data').select('*');
        if(!s || s.length === 0) { alert("어드민에서 강화 데이터를 먼저 만드세요!"); return; }
        s.forEach(item => swords[item.level] = item);

        // 2. 유저 정보 로드 (없으면 기본값 생성)
        let { data: p, error } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
        if (error || !p) {
            const { data: newUser } = await supabaseClient.from('profiles').insert([
                { id: session.user.id, nickname: '모험가', gold: 1000, current_sword_lvl: 1 }
            ]).select().single();
            p = newUser;
        }
        user = p;
        document.getElementById('loading').style.display='none';
        document.getElementById('game-ui').style.display='block';
        updateUI();
    }

    function updateUI() {
        const s = swords[user.current_sword_lvl] || swords[1];
        document.getElementById('nick-display').innerText = user.nickname + "님";
        document.getElementById('gold-display').innerText = user.gold.toLocaleString() + "G";
        document.getElementById('sw-name').innerText = `[+${s.level-1}] ${s.name}`;
        document.getElementById('cost-info').innerText = `비용: ${s.upgrade_cost.toLocaleString()}G | 확률: ${Math.floor(s.success_rate*100)}%`;
        document.getElementById('sword-img').src = s.image_url || "https://via.placeholder.com/150";
    }

    function anim(amt, type) {
        const e = document.createElement('div'); e.className = 'money-eff';
        e.style.color = type==='plus'?'#3498db':'#e74c3c';
        e.innerText = (type==='plus'?'+':'-') + amt.toLocaleString() + 'G';
        document.getElementById('gold-anchor').appendChild(e);
        setTimeout(() => e.remove(), 2500);
    }

    async function handleUpgrade() {
        const s = swords[user.current_sword_lvl];
        if(user.gold < s.upgrade_cost) { alert("골드가 부족합니다."); return; }
        anim(s.upgrade_cost, 'minus');
        const success = Math.random() < s.success_rate;
        const nextLvl = success ? user.current_sword_lvl + 1 : user.current_sword_lvl;
        if (success && !swords[nextLvl]) { alert("마지막 단계입니다!"); return; }
        
        user.gold -= s.upgrade_cost;
        user.current_sword_lvl = nextLvl;
        await supabaseClient.from('profiles').update({ gold: user.gold, current_sword_lvl: nextLvl }).eq('id', user.id);
        document.getElementById('npc-msg').innerText = success ? "강화 성공!" : "실패일세... 하지만 파괴되진 않았어.";
        updateUI();
    }

    async function redeem() {
        const code = prompt("코드를 입력하세요.");
        const { data } = await supabaseClient.from('reward_codes').select('*').eq('code', code).single();
        if(!data) return alert("없는 코드입니다.");
        user.gold += data.reward_gold;
        await supabaseClient.from('profiles').update({ gold: user.gold }).eq('id', user.id);
        anim(data.reward_gold, 'plus');
        updateUI();
    }
    init();
</script>
</body>
</html>
