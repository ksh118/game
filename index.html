<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>codetbase - 크리스마스 강화</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --main-red: #c0392b; --dark-gray: #2c3e50; }
        body { background-color: #e6e9ed; font-family: 'Pretendard', sans-serif; display: flex; justify-content: center; margin: 0; padding: 20px 0; }
        .game-container { width: 100%; max-width: 420px; background: white; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; display: none; }
        
        .header-bar { background: var(--dark-gray); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .gold-display { font-size: 18px; font-weight: bold; position: relative; }

        .npc-talk { background: #f8f9fa; border: 1px solid #ddd; border-radius: 15px; margin: 15px; padding: 15px; text-align: left; }
        .npc-name { font-weight: bold; color: var(--main-red); display: block; margin-bottom: 5px; }

        .image-box { background: #eee; height: 250px; display: flex; align-items: center; justify-content: center; margin: 0 15px; border-radius: 20px; overflow: hidden; }
        .sword-img { max-width: 85%; max-height: 85%; object-fit: contain; transition: 0.1s; }
        .shake { animation: shake 0.1s infinite; }
        @keyframes shake { 0% {transform: rotate(-2deg);} 50% {transform: rotate(2deg);} 100% {transform: rotate(-2deg);} }

        .money-effect { position: absolute; right: 0; top: 0; font-weight: bold; font-size: 26px; animation: floatUp 2.5s ease-out forwards; pointer-events: none; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 0; } 10% { opacity: 1; } 100% { transform: translateY(-130px); opacity: 0; } }

        .btn-group { display: flex; gap: 10px; padding: 15px; }
        button { flex: 1; padding: 16px; border-radius: 15px; border: none; font-weight: bold; font-size: 18px; cursor: pointer; }
    </style>
</head>
<body>
<div id="loading" style="margin-top: 100px;">로딩 중...</div>
<div class="game-container" id="game-ui">
    <div class="header-bar">
        <span id="nick-display" style="color:#f1c40f;">님</span>
        <div style="display: flex; gap: 10px; align-items: center;">
            <button onclick="redeemCode()" style="background:#f1c40f; color:#333; font-size:12px; padding:5px 10px; border-radius:5px; border:none; font-weight:bold;">보상코드</button>
            <div class="gold-display" id="gold-anchor"><span id="gold-display">0G</span></div>
        </div>
    </div>
    <div class="npc-talk">
        <span class="npc-name" id="npc-name">대장장이 루돌프</span>
        <div id="npc-msg">"무엇을 강화하겠나?"</div>
    </div>
    <div class="image-box"><img id="sword-img" src="" class="sword-img"></div>
    <div style="padding:15px;">
        <div id="sw-name" style="font-size:18px; font-weight:bold;">이름</div>
        <div id="cost-info" style="font-size:13px; color:#888; margin-top:5px;">비용: 0G | 확률: 0%</div>
    </div>
    <div class="btn-group">
        <button onclick="handleSell()" style="background:#f1f2f6; color:#999;">판매</button>
        <button onclick="handleUpgrade()" style="background:var(--dark-gray); color:white;">강화하기</button>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let user = null, swords = {};

    async function init() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) { window.location.href="login.html"; return; }
        const { data: s } = await supabaseClient.from('sword_data').select('*');
        s.forEach(item => swords[item.level] = item);
        const { data: p } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
        user = p;
        document.getElementById('loading').style.display='none';
        document.getElementById('game-ui').style.display='block';
        updateUI();
    }

    function updateUI() {
        const s = swords[user.current_sword_lvl];
        if(!s) return;
        document.getElementById('nick-display').innerText = user.nickname + "님";
        document.getElementById('gold-display').innerText = user.gold.toLocaleString() + "G";
        document.getElementById('sw-name').innerText = `[+${user.current_sword_lvl-1}] ${s.name}`;
        document.getElementById('cost-info').innerText = `비용: ${s.upgrade_cost.toLocaleString()}G | 확률: ${Math.floor(s.success_rate*100)}%`;
        document.getElementById('sword-img').src = s.image_url || "https://via.placeholder.com/150";
    }

    function animateGold(amt, type) {
        const eff = document.createElement('div');
        eff.className = 'money-effect';
        eff.style.color = type==='plus' ? '#3498db' : '#e74c3c';
        eff.innerText = (type==='plus'?'+':'-') + amt.toLocaleString() + "G";
        document.getElementById('gold-anchor').appendChild(eff);
        setTimeout(() => eff.remove(), 2500);
    }

    async function handleUpgrade() {
        const s = swords[user.current_sword_lvl];
        if(user.gold < s.upgrade_cost) { alert("골드가 부족합니다."); return; }
        document.getElementById('sword-img').classList.add('shake');
        animateGold(s.upgrade_cost, 'minus');
        const success = Math.random() < s.success_rate;
        const nextLvl = success ? user.current_sword_lvl + 1 : user.current_sword_lvl;
        const nextGold = user.gold - s.upgrade_cost;
        await supabaseClient.from('profiles').update({ gold: nextGold, current_sword_lvl: nextLvl }).eq('id', user.id);
        setTimeout(() => {
            document.getElementById('sword-img').classList.remove('shake');
            user.gold = nextGold; user.current_sword_lvl = nextLvl;
            document.getElementById('npc-msg').innerText = success ? "강화 성공!" : "실패... 유지되었습니다.";
            updateUI();
        }, 600);
    }

    async function redeemCode() {
        const code = prompt("보상코드를 입력하세요.");
        if(!code) return;
        const { data } = await supabaseClient.from('reward_codes').select('*').eq('code', code).single();
        if(!data) { alert("잘못된 코드입니다."); return; }
        const nextGold = user.gold + data.reward_gold;
        await supabaseClient.from('profiles').update({ gold: nextGold }).eq('id', user.id);
        user.gold = nextGold;
        animateGold(data.reward_gold, 'plus');
        updateUI();
        alert(data.reward_gold + "G 지급 완료!");
    }

    init();
</script>
</body>
</html>
