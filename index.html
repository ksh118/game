<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>codetbase - í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ê°•í™”</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* (ê¸°ì¡´ CSSì™€ ë™ì¼í•˜ë¯€ë¡œ ì¤‘ë³µ ìƒëµ, í•µì‹¬ ê¸°ëŠ¥ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤) */
        :root { --main-red: #c0392b; --main-green: #27ae60; --dark-gray: #2c3e50; }
        body { background-color: #e6e9ed; font-family: 'Pretendard', sans-serif; display: flex; justify-content: center; margin: 0; padding: 20px 0; }
        .game-container { width: 100%; max-width: 420px; background: white; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; position: relative; display: none; } /* ì´ˆê¸°ì—” ìˆ¨ê¹€ */
        .header-bar { background: var(--dark-gray); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .nickname { font-weight: bold; font-size: 16px; color: #f1c40f; }
        .gold-display { font-size: 18px; font-weight: bold; position: relative; }
        .npc-talk { background: #f8f9fa; border: 1px solid #ddd; border-radius: 15px; margin: 15px; padding: 15px; text-align: left; }
        .npc-name { font-weight: bold; color: var(--main-red); margin-bottom: 5px; display: block; }
        .image-box { background: #eee; height: 220px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; margin: 0 15px; border-radius: 20px; }
        .sword-img { width: 200px; transition: transform 0.1s; }
        .item-info { padding: 15px; text-align: left; }
        .btn-group { display: flex; gap: 10px; padding: 15px; }
        button { flex: 1; padding: 16px; border-radius: 15px; border: none; font-weight: bold; font-size: 18px; cursor: pointer; }
        .upgrade-btn { background: var(--dark-gray); color: white; }
        .money-effect { position: absolute; right: 20px; top: 50px; font-weight: bold; font-size: 24px; animation: floatUp 2.5s ease-out forwards; z-index: 100; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 0; } 10% { opacity: 1; } 100% { transform: translateY(-100px); opacity: 0; } }
    </style>
</head>
<body>

<div id="loading" style="margin-top: 50px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

<div class="game-container" id="game-ui">
    <div class="header-bar">
        <span class="nickname" id="nick-display">...ë‹˜</span>
        <div class="gold-display" id="gold-anchor">
            <span id="gold-display">0G</span>
        </div>
    </div>

    <div class="npc-talk">
        <span class="npc-name" id="npc-name">ëŒ€ì¥ì¥ì´ ë£¨ëŒí”„</span>
        <div class="npc-msg" id="npc-msg">"ì–´ì„œì˜¤ê²Œ! ì˜¤ëŠ˜ì€ ë¬´ì—‡ì„ ê°•í™”í•˜ëŸ¬ ì™”ë‚˜?"</div>
    </div>

    <div class="image-box">
        <div id="flash-layer"></div>
        <img id="sword-img" src="https://cdn-icons-png.flaticon.com/512/3233/3233514.png" class="sword-img">
    </div>

    <div class="item-info">
        <div class="item-lvl-name" id="sw-name">ë¡œë”© ì¤‘...</div>
        <div class="item-desc" id="sw-desc">-</div>
        <div style="margin-top:10px; font-size:13px; color:#555;">
            ğŸ’° ë¹„ìš©: <span id="upgrade-cost">0</span>G | ğŸ“ˆ í™•ë¥ : <span id="success-rate">0</span>%
        </div>
    </div>

    <div class="btn-group">
        <button class="upgrade-btn" id="btn-upgrade" onclick="handleUpgrade()">ê°•í™”í•˜ê¸°</button>
        <button onclick="handleLogout()" style="background:#eee; font-size:14px; flex:0.4;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let user = null, swords = {};

    async function init() {
        // 1. ì„¸ì…˜ í™•ì¸
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) {
            window.location.href = "login.html";
            return;
        }

        // 2. ê²€ ë°ì´í„° ë¡œë“œ
        const { data: sData, error: sError } = await supabaseClient.from('sword_data').select('*');
        if (sError) return alert("ê²€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        sData.forEach(s => swords[s.level] = s);

        // 3. ìœ ì € í”„ë¡œí•„ ë¡œë“œ
        const { data: pData, error: pError } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
        
        if (pError || !pData) {
            alert("í”„ë¡œí•„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ê°€ì… ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
            return;
        }

        user = pData;
        document.getElementById('loading').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        updateUI();
    }

    function updateUI() {
        if (!user || !swords[user.current_sword_lvl]) return;
        const s = swords[user.current_sword_lvl];
        
        document.getElementById('nick-display').innerText = `${user.nickname}ë‹˜`;
        document.getElementById('gold-display').innerText = `${user.gold.toLocaleString()}G`;
        document.getElementById('sw-name').innerText = `[+${user.current_sword_lvl - 1}] ${s.name}`;
        document.getElementById('sw-desc').innerText = s.description;
        document.getElementById('upgrade-cost').innerText = s.upgrade_cost.toLocaleString();
        document.getElementById('success-rate').innerText = Math.floor(s.success_rate * 100);
    }

    // (ì• ë‹ˆë©”ì´ì…˜ ë° ê°•í™” ë¡œì§ì€ ì´ì „ê³¼ ë™ì¼í•˜ë©° ë³€ìˆ˜ëª…ë§Œ userë¡œ í†µì¼í–ˆìŠµë‹ˆë‹¤)
    function animateMoney(amount, type) {
        const anchor = document.getElementById('gold-anchor');
        const effect = document.createElement('div');
        effect.className = 'money-effect';
        effect.style.color = (type === 'minus') ? '#e74c3c' : '#3498db';
        effect.innerText = (type === 'minus' ? '-' : '+') + amount.toLocaleString() + 'G';
        anchor.appendChild(effect);
        setTimeout(() => effect.remove(), 2500);
    }

    async function handleUpgrade() {
        const s = swords[user.current_sword_lvl];
        if (user.gold < s.upgrade_cost) {
            document.getElementById('npc-msg').innerText = "ëŒ€ì¥ì¥ì´ê°€ ë§í•©ë‹ˆë‹¤: ê³¨ë“œê°€ ë¶€ì¡±í•˜êµ¬ë§Œ!";
            return;
        }

        const success = Math.random() < s.success_rate;
        const nextLvl = success ? user.current_sword_lvl + 1 : Math.max(1, user.current_sword_lvl - 1);
        const nextGold = user.gold - s.upgrade_cost;

        const { error } = await supabaseClient.from('profiles').update({ gold: nextGold, current_sword_lvl: nextLvl }).eq('id', user.id);

        if (!error) {
            animateMoney(s.upgrade_cost, 'minus');
            user.gold = nextGold;
            user.current_sword_lvl = nextLvl;
            document.getElementById('npc-msg').innerText = success ? "ì˜¤! ê°•í™”ì— ì„±ê³µí–ˆë„¤!" : "ì´ëŸ°... ì‹¤íŒ¨í–ˆêµ¬ë§Œ.";
            updateUI();
        }
    }

    async function handleLogout() {
        await supabaseClient.auth.signOut();
        window.location.href = "login.html";
    }

    init();
</script>
</body>
</html>
