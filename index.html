<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>codetbase - ê°•í™” ê²Œì„</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #e6e9ed; font-family: 'Pretendard', sans-serif; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .game-container { width: 100%; max-width: 400px; background: white; border-radius: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; display: none; }
        
        /* ì•Œë¦¼ì°½ */
        #ban-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; text-align: center; }
        #full-effect { position: fixed; top:0; left:0; width:100%; height:100%; z-index: 9999; display: none; align-items: center; justify-content: center; font-size: 40px; font-weight: 900; color: white; pointer-events: none; }

        .header { background: #2c3e50; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .gold-display { color: #f1c40f; font-weight: bold; font-size: 18px; position: relative; }
        .money-anim { position: absolute; right: 0; top: -20px; animation: upFade 2s forwards; font-weight: bold; }
        @keyframes upFade { 0% { opacity: 0; transform: translateY(0); } 20% { opacity: 1; } 100% { opacity: 0; transform: translateY(-50px); } }

        .img-area { background: #f0f0f0; height: 220px; margin: 15px; border-radius: 20px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .sword-img { max-width: 80%; max-height: 80%; object-fit: contain; }
        .hammering { animation: hammer 0.1s infinite; }
        @keyframes hammer { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .btn-group { padding: 15px; display: flex; gap: 10px; }
        button { flex: 1; padding: 16px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }
        
        .rank-box { width: 100%; max-width: 400px; background: white; margin-top: 15px; border-radius: 20px; padding: 15px; box-sizing: border-box; }
        .rank-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 14px; }
    </style>
</head>
<body>
<div id="loading">ë°ì´í„° ë¡œë”© ì¤‘...</div>

<div id="ban-overlay"><h1>ğŸš«</h1><h2>ì„ì‹œ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.</h2><p>ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.</p></div>
<div id="full-effect"></div>

<div class="game-container" id="game-ui">
    <div class="header">
        <span id="u-nick">...</span>
        <div class="gold-display" id="gold-container"><span id="u-gold">0</span>G</div>
    </div>

    <div style="padding:15px; font-size:14px;"><b>ë£¨ëŒí”„:</b> <span id="npc-text" style="color:#666;">ì–´ì„œì˜¤ê²Œ! ë¬´ì—‡ì„ ê°•í™”í•˜ê² ë‚˜?</span></div>
    
    <div class="img-area"><img id="s-img" src="" class="sword-img"></div>
    
    <div style="padding:0 20px 15px;">
        <div id="s-name" style="font-size:20px; font-weight:bold;">ì´ë¦„</div>
        <div id="s-desc" style="font-size:13px; color:#7f8c8d; margin-top:5px;">ì„¤ëª…</div>
        <div id="s-info" style="font-size:14px; color:#2c3e50; margin-top:10px; font-weight:bold;">ë¹„ìš©: 0G | í™•ë¥ : 0%</div>
    </div>

    <div class="btn-group">
        <button onclick="redeem()" style="background:#f1f2f6;">ì½”ë“œ ì…ë ¥</button>
        <button onclick="handleUpgrade()" style="background:#2c3e50; color:white;">ê°•í™”í•˜ê¸°</button>
    </div>
</div>

<div class="rank-box">
    <h4 style="margin:0 0 10px 0;">ğŸ† ì „ì„¤ì˜ ìˆœìœ„</h4>
    <div id="rank-list"></div>
</div>

<script>
    const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let user = null, swords = {};

    async function init() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if(!session) { location.href="login.html"; return; }

        const { data: p } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
        if(p.is_banned) { document.getElementById('loading').style.display='none'; document.getElementById('ban-overlay').style.display='flex'; return; }
        user = p;

        const { data: s } = await supabaseClient.from('sword_data').select('*').order('level', { ascending: true });
        s.forEach(i => swords[i.level] = i);

        document.getElementById('loading').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        updateUI(); loadRank();
    }

    function updateUI() {
        const item = swords[user.current_sword_lvl] || swords[1];
        document.getElementById('u-nick').innerText = user.nickname + "ë‹˜";
        document.getElementById('u-gold').innerText = user.gold.toLocaleString();
        document.getElementById('s-name').innerText = `[+${item.level-1}] ${item.name}`;
        document.getElementById('s-desc').innerText = item.description || "ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.";
        document.getElementById('s-info').innerText = `ë¹„ìš©: ${item.upgrade_cost.toLocaleString()}G | í™•ë¥ : ${item.success_rate*100}%`;
        document.getElementById('s-img').src = item.image_url;
    }

    function animGold(amt, plus=false) {
        const div = document.createElement('div'); div.className = 'money-anim';
        div.style.color = plus ? '#3498db' : '#e74c3c';
        div.innerText = (plus ? '+' : '-') + amt.toLocaleString() + 'G';
        document.getElementById('gold-container').appendChild(div);
        setTimeout(() => div.remove(), 2000);
    }

    function showEffect(success) {
        const el = document.getElementById('full-effect');
        el.style.display = 'flex';
        el.style.backgroundColor = success ? 'rgba(52, 152, 219, 0.8)' : 'rgba(231, 76, 60, 0.8)';
        el.innerText = success ? "ê°•í™” ì„±ê³µ!!" : "ê°•í™” ì‹¤íŒ¨...";
        setTimeout(() => el.style.display = 'none', 2000);
    }

    async function handleUpgrade() {
        const s = swords[user.current_sword_lvl];
        if(user.gold < s.upgrade_cost) return alert("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");

        const img = document.getElementById('s-img');
        img.classList.add('hammering');
        animGold(s.upgrade_cost);

        const success = Math.random() < s.success_rate;
        const nextLvl = success ? user.current_sword_lvl + 1 : user.current_sword_lvl;
        if(success && !swords[nextLvl]) { img.classList.remove('hammering'); return alert("ìµœê³  ë ˆë²¨ ë„ë‹¬!"); }

        const nextGold = user.gold - s.upgrade_cost;
        await supabaseClient.from('profiles').update({ gold: nextGold, current_sword_lvl: nextLvl }).eq('id', user.id);

        setTimeout(() => {
            img.classList.remove('hammering');
            user.gold = nextGold; user.current_sword_lvl = nextLvl;
            showEffect(success);
            document.getElementById('npc-text').innerText = success ? "ì˜¤! ëŒ€ë‹¨í•œ ë¬´ê¸°ê°€ íƒ„ìƒí–ˆêµ°!" : "ì´ëŸ°... ì‹¤íŒ¨í–ˆêµ¬ë§Œ. ë‹¤ì‹œ í•´ë³´ê²Œ.";
            updateUI(); loadRank();
        }, 800);
    }

    async function redeem() {
        const code = prompt("ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        if(!code) return;
        const { data } = await supabaseClient.from('reward_codes').select('*').eq('code', code).single();
        if(!data) return alert("ì˜ëª»ëœ ì½”ë“œì…ë‹ˆë‹¤.");
        
        user.gold += data.reward_gold;
        await supabaseClient.from('profiles').update({ gold: user.gold }).eq('id', user.id);
        animGold(data.reward_gold, true);
        updateUI(); loadRank();
        alert("ë³´ìƒì´ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤!");
    }

    async function loadRank() {
        const { data } = await supabaseClient.from('profiles').select('nickname, gold').order('gold', { ascending: false }).limit(5);
        document.getElementById('rank-list').innerHTML = data.map((r, i) => `
            <div class="rank-item"><span>${i+1}. ${r.nickname}</span><b>${r.gold.toLocaleString()}G</b></div>
        `).join('');
    }
    init();
</script>
</body>
</html>
