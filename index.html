<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>codetbase - ê°•í™”</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #e6e9ed; font-family: 'Pretendard', sans-serif; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .game-container { width: 100%; max-width: 400px; background: white; border-radius: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; display: none; }
        
        /* ì •ì§€ í™”ë©´ ì»¤ë²„ */
        #ban-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9);
            color: white; display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10000; text-align: center; padding: 20px;
        }

        /* ì„±ê³µ/ì‹¤íŒ¨ íš¨ê³¼ (ê¸°ì¡´ ìš”ì²­ì‚¬í•­) */
        #full-effect {
            position: fixed; top:0; left:0; width:100%; height:100%; z-index: 9999;
            display: none; align-items: center; justify-content: center;
            font-size: 40px; font-weight: 900; color: white;
        }

        .header { background: #2c3e50; color: white; padding: 15px; display: flex; justify-content: space-between; }
        .money-anim { position: absolute; right: 10px; top: -20px; font-weight: bold; animation: upFade 2s forwards; }
        @keyframes upFade { 0% { opacity:0; transform:translateY(0); } 100% { opacity:0; transform:translateY(-50px); } }
        
        .rank-box { width: 100%; max-width: 400px; background: white; margin-top: 15px; border-radius: 20px; padding: 15px; box-sizing: border-box; }
        button { cursor: pointer; border: none; font-weight: bold; border-radius: 12px; }
    </style>
</head>
<body>
<div id="loading">ë°ì´í„° í™•ì¸ ì¤‘...</div>

<div id="ban-overlay">
    <h1 style="font-size: 50px;">ğŸš«</h1>
    <h2>ì„ì‹œ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.</h2>
    <p>ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.</p>
</div>

<div id="full-effect"></div>

<div class="game-container" id="game-ui">
    <div class="header">
        <span id="u-nick">...</span>
        <div style="position:relative;" id="gold-area">
            <span id="u-gold" style="color:#f1c40f; font-weight:bold;">0</span>G
        </div>
    </div>
    
    <div style="padding:15px; color:#555;"><b>ë£¨ëŒí”„:</b> <span id="npc-text">ë°˜ê°‘ë„¤!</span></div>
    <div style="background:#eee; height:200px; margin:10px; border-radius:15px; display:flex; align-items:center; justify-content:center;">
        <img id="s-img" src="" style="max-width:80%; max-height:80%;">
    </div>

    <div style="padding:15px;">
        <div id="s-name" style="font-size:20px; font-weight:bold;">ì•„ì´í…œ</div>
        <div id="s-desc" style="font-size:13px; color:#888;">ì„¤ëª…</div>
        <div id="s-info" style="font-weight:bold; margin-top:10px;">ë¹„ìš©: 0G | í™•ë¥ : 0%</div>
    </div>

    <div style="display:flex; gap:10px; padding:15px;">
        <button onclick="handleUpgrade()" style="flex:1; padding:15px; background:#2c3e50; color:white;">ê°•í™”í•˜ê¸°</button>
    </div>
</div>

<div class="rank-box">
    <h4 style="margin:0 0 10px 0;">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h4>
    <div id="rank-list"></div>
</div>

<script>
    const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let user = null, swords = {};

    async function init() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if(!session) { location.href="login.html"; return; }

        // ìœ ì € ì •ë³´ ë¡œë“œ ë° ì •ì§€ í™•ì¸
        const { data: p } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
        if(p.is_banned) {
            document.getElementById('loading').style.display='none';
            document.getElementById('ban-overlay').style.display='flex';
            return;
        }
        user = p;

        // ì•„ì´í…œ ì •ë³´ ë¡œë“œ
        const { data: s } = await supabaseClient.from('sword_data').select('*').order('level', { ascending: true });
        s.forEach(i => swords[i.level] = i);

        document.getElementById('loading').style.display='none';
        document.getElementById('game-ui').style.display='block';
        updateUI();
        loadRank();
    }

    function updateUI() {
        const item = swords[user.current_sword_lvl] || swords[1];
        document.getElementById('u-nick').innerText = user.nickname + "ë‹˜";
        document.getElementById('u-gold').innerText = user.gold.toLocaleString();
        document.getElementById('s-name').innerText = `[+${item.level-1}] ${item.name}`;
        document.getElementById('s-desc').innerText = item.description || "ì„¤ëª… ì—†ìŒ";
        document.getElementById('s-info').innerText = `ë¹„ìš©: ${item.upgrade_cost.toLocaleString()}G | í™•ë¥ : ${item.success_rate*100}%`;
        document.getElementById('s-img').src = item.image_url;
    }

    function showEffect(success) {
        const el = document.getElementById('full-effect');
        el.style.display = 'flex';
        el.style.backgroundColor = success ? 'rgba(52, 152, 219, 0.8)' : 'rgba(231, 76, 60, 0.8)';
        el.innerText = success ? "ê°•í™” ì„±ê³µ!!" : "ê°•í™” ì‹¤íŒ¨...";
        setTimeout(() => el.style.display = 'none', 2000);
    }

    async function handleUpgrade() {
        const s = swords[user.current_sword_lvl];
        if(user.gold < s.upgrade_cost) return alert("ê³¨ë“œ ë¶€ì¡±!");

        const success = Math.random() < s.success_rate;
        const nextLvl = success ? user.current_sword_lvl + 1 : user.current_sword_lvl;
        if(success && !swords[nextLvl]) return alert("ìµœê³  ë ˆë²¨!");

        user.gold -= s.upgrade_cost;
        await supabaseClient.from('profiles').update({ gold: user.gold, current_sword_lvl: nextLvl }).eq('id', user.id);
        
        user.current_sword_lvl = nextLvl;
        showEffect(success);
        updateUI();
        loadRank();
    }

    async function loadRank() {
        const { data } = await supabaseClient.from('profiles').select('nickname, gold').order('gold', { ascending: false }).limit(5);
        document.getElementById('rank-list').innerHTML = data.map((r, i) => `
            <div class="rank-item"><span>${i+1}. ${r.nickname}</span><b>${r.gold.toLocaleString()}G</b></div>
        `).join('');
    }

    init();
</script>
</body>
</html>
