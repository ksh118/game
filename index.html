<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>codetbase - í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ê°•í™”</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --main-red: #c0392b; --main-green: #27ae60; --dark-gray: #2c3e50; }
        body { background-color: #e6e9ed; font-family: 'Pretendard', sans-serif; display: flex; justify-content: center; margin: 0; padding: 20px 0; }
        .game-container { width: 100%; max-width: 420px; background: white; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; position: relative; }

        /* ìƒë‹¨ ë°” */
        .header-bar { background: var(--dark-gray); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .nickname { font-weight: bold; font-size: 16px; color: #f1c40f; }
        .gold-display { font-size: 18px; font-weight: bold; position: relative; }

        /* ëŒ€ì¥ì¥ì´ ë§í’ì„  (ì´ë¯¸ì§€ ëª¨í‹°ë¸Œ) */
        .npc-talk { background: #f8f9fa; border: 1px solid #ddd; border-radius: 15px; margin: 15px; padding: 15px; text-align: left; position: relative; }
        .npc-name { font-weight: bold; color: var(--main-red); margin-bottom: 5px; display: block; }
        .npc-msg { font-size: 14px; line-height: 1.5; color: #333; }

        /* ì´ë¯¸ì§€ ë°•ìŠ¤ */
        .image-box { background: #eee; height: 220px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; margin: 0 15px; border-radius: 20px; }
        .sword-img { width: 200px; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2)); transition: transform 0.1s; }
        .shake { animation: shake 0.1s infinite; }
        @keyframes shake { 0% {transform: rotate(-3deg);} 50% {transform: rotate(3deg);} 100% {transform: rotate(-3deg);} }

        /* ê³¨ë“œ ë³€ë™ íš¨ê³¼ (2.5ì´ˆ ìœ ì§€) */
        .money-effect { 
            position: absolute; right: 20px; top: 50px; font-weight: bold; font-size: 24px; pointer-events: none; 
            animation: floatUp 2.5s ease-out forwards; z-index: 100;
        }
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(-100px); opacity: 0; }
        }

        /* ìƒì„¸ ì •ë³´ */
        .item-info { padding: 15px; text-align: left; }
        .item-lvl-name { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .item-desc { color: #666; font-size: 14px; margin-bottom: 10px; }
        .cost-info { background: #f1f2f6; border-radius: 10px; padding: 10px; font-size: 13px; color: #555; }

        /* ë²„íŠ¼ */
        .btn-group { display: flex; gap: 10px; padding: 15px; }
        button { flex: 1; padding: 16px; border-radius: 15px; border: none; font-weight: bold; font-size: 18px; cursor: pointer; transition: 0.2s; }
        .sell-btn { background: #ecf0f1; color: #7f8c8d; }
        .upgrade-btn { background: var(--dark-gray); color: white; }
        button:active { transform: scale(0.95); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .flash { position: absolute; inset:0; background: white; animation: flashAnim 0.4s; pointer-events: none; opacity: 0; }
        @keyframes flashAnim { 0% {opacity: 1;} 100% {opacity: 0;} }
    </style>
</head>
<body>

<div class="game-container">
    <div class="header-bar">
        <span class="nickname" id="nick-display">ë¡œë”© ì¤‘...</span>
        <div class="gold-display" id="gold-anchor">
            <span id="gold-display">0G</span>
        </div>
    </div>

    <div class="npc-talk">
        <span class="npc-name" id="npc-name">ëŒ€ì¥ì¥ì´ ë£¨ëŒí”„</span>
        <div class="npc-msg" id="npc-msg">"ì–´ì„œì˜¤ê²Œ! ì˜¤ëŠ˜ì€ ë¬´ì—‡ì„ ê°•í™”í•˜ëŸ¬ ì™”ë‚˜?"</div>
    </div>

    <div class="image-box" id="sword-box">
        <div id="flash-layer"></div>
        <img id="sword-img" src="https://cdn-icons-png.flaticon.com/512/3233/3233514.png" class="sword-img">
    </div>

    <div class="item-info">
        <div class="item-lvl-name" id="sw-name">ì•„ì´í…œ ì´ë¦„</div>
        <div class="item-desc" id="sw-desc">ì•„ì´í…œ ì„¤ëª…ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤.</div>
        <div class="cost-info">
            ğŸ’° ê°•í™” ë¹„ìš©: <span id="upgrade-cost">0</span>G<br>
            ğŸ“ˆ ì„±ê³µ í™•ë¥ : <span id="success-rate">0</span>%
        </div>
    </div>

    <div class="btn-group">
        <button class="sell-btn" id="btn-sell" onclick="handleSell()">íŒë§¤</button>
        <button class="upgrade-btn" id="btn-upgrade" onclick="handleUpgrade()">ê°•í™”í•˜ê¸°</button>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let user = null, swords = {};
    const successMsgs = ["ê³ ì‘ +1ì´ ë˜ì—ˆë‹¤ê³  ì¢‹ì•„í•˜ëŠëƒ?", "í˜¸ì˜¤, ì œë²• ë‚ ì¹´ë¡œì›Œì¡Œêµ°!", "ì´ ê²€ì— ê²¨ìš¸ë°¤ì˜ ëƒ‰ê¸°ê°€ ì„œë ¸ë‹¤."];
    const failMsgs = ["ì•„ê¹êµ°, ê±°ì˜ ë‹¤ë“¬ì–´ì¡ŒëŠ”ë°.", "ì¬ë£Œ íƒ“ì´ì•¼, ì¬ë£Œ íƒ“.", "ë§ì¹˜ì§ˆ í•œ ë²ˆì´ ì•„ì‰½êµ¬ë§Œ."];

    async function init() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) { window.location.href = "login.html"; return; }
        
        const { data: sData } = await supabaseClient.from('sword_data').select('*');
        sData.forEach(s => swords[s.level] = s);

        const { data: pData } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
        user = pData;
        updateUI();
    }

    function updateUI() {
        const s = swords[user.current_sword_lvl];
        document.getElementById('nick-display').innerText = `ID: ${user.nickname}`;
        document.getElementById('gold-display').innerText = `${user.gold.toLocaleString()}G`;
        document.getElementById('sw-name').innerText = `[+${user.current_sword_lvl - 1}] ${s.name}`;
        document.getElementById('sw-desc').innerText = s.description;
        document.getElementById('upgrade-cost').innerText = s.upgrade_cost.toLocaleString();
        document.getElementById('success-rate').innerText = Math.floor(s.success_rate * 100);
        document.getElementById('btn-sell').disabled = (user.current_sword_lvl === 1);
    }

    function animateMoney(amount, type) {
        const anchor = document.getElementById('gold-anchor');
        const effect = document.createElement('div');
        effect.className = 'money-effect';
        effect.style.color = (type === 'minus') ? '#e74c3c' : '#3498db';
        effect.innerText = (type === 'minus' ? '-' : '+') + amount.toLocaleString() + 'G';
        anchor.appendChild(effect);
        setTimeout(() => effect.remove(), 2500);
    }

    async function handleUpgrade() {
        const s = swords[user.current_sword_lvl];
        if (user.gold < s.upgrade_cost) {
            document.getElementById('npc-name').innerText = "ëŒ€ì¥ì¥ì´ ë£¨ëŒí”„";
            document.getElementById('npc-msg').innerText = "ê³¨ë“œê°€ ë¶€ì¡±í•´. ê³¨ë“œë¥¼ ë” ëª¨ìœ¼ê³  ì˜¤ì‹œê²Œë‚˜.";
            return;
        }

        const img = document.getElementById('sword-img');
        img.classList.add('shake');
        animateMoney(s.upgrade_cost, 'minus');

        const success = Math.random() < s.success_rate;
        const nextLvl = success ? user.current_sword_lvl + 1 : Math.max(1, user.current_sword_lvl - 1);
        const nextGold = user.gold - s.upgrade_cost;

        await supabaseClient.from('profiles').update({ gold: nextGold, current_sword_lvl: nextLvl }).eq('id', user.id);

        setTimeout(() => {
            img.classList.remove('shake');
            user.gold = nextGold; user.current_sword_lvl = nextLvl;
            
            if (success) {
                document.getElementById('flash-layer').classList.add('flash');
                setTimeout(() => document.getElementById('flash-layer').classList.remove('flash'), 400);
                document.getElementById('npc-msg').innerText = `"${successMsgs[Math.floor(Math.random()*successMsgs.length)]}"`;
            } else {
                document.getElementById('npc-msg').innerText = `"${failMsgs[Math.floor(Math.random()*failMsgs.length)]}"`;
            }

            updateUI();
        }, 600);
    }

    async function handleSell() {
        const s = swords[user.current_sword_lvl];
        const earn = s.sell_price;
        const nextGold = user.gold + earn;
        await supabaseClient.from('profiles').update({ gold: nextGold, current_sword_lvl: 1 }).eq('id', user.id);
        
        animateMoney(earn, 'plus');
        user.gold = nextGold; user.current_sword_lvl = 1;
        
        document.getElementById('npc-name').innerText = "ëˆˆì‚¬ëŒ ê°ì •ì‚¬";
        document.getElementById('npc-msg').innerText = `"í›Œë¥­í•œ ê²€ì´êµ°! ${earn.toLocaleString()}Gì— ë§¤ì…í•˜ê² ë„¤."`;
        updateUI();
    }

    init();
</script>
</body>
</html>
