<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>codetbase - ì „ì„¤ì˜ ê°•í™”</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #e6e9ed; font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px 0; }
        .game-container { width: 100%; max-width: 420px; background: white; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; display: none; }
        .header { background: #2c3e50; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .image-area { background: #eee; height: 250px; display: flex; align-items: center; justify-content: center; margin: 15px; border-radius: 20px; position: relative; }
        .sword-img { max-width: 80%; max-height: 80%; object-fit: contain; }
        .hammering { animation: hammer 0.1s infinite; }
        @keyframes hammer { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .btn-group { display: flex; gap: 10px; padding: 15px; }
        button { flex: 1; padding: 16px; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; }
        
        /* ìˆœìœ„í‘œ ìŠ¤íƒ€ì¼ */
        .rank-box { width: 100%; max-width: 420px; background: white; margin-top: 20px; border-radius: 20px; padding: 15px; box-sizing: border-box; }
        .rank-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 14px; }
        .rank-item:last-child { border: none; }
    </style>
</head>
<body>
<div id="loading">ë¡œë”© ì¤‘...</div>

<div class="game-container" id="game-ui">
    <div class="header">
        <span id="nick-display" style="color:#f1c40f; font-weight:bold;">ë¡œë”©ì¤‘</span>
        <span id="gold-display" style="font-weight:bold;">0G</span>
    </div>
    
    <div style="padding:15px; background:#f8f9fa; margin:15px; border-radius:15px; border:1px solid #ddd;">
        <b id="npc-msg">"ì–´ì„œì˜¤ê²Œ! ê°•í™”ë¥¼ ì‹œì‘í• í…ê°€?"</b>
    </div>

    <div class="image-area"><img id="sword-img" src="" class="sword-img"></div>
    
    <div style="padding:0 20px;">
        <div id="sw-name" style="font-size:22px; font-weight:bold;">ì´ë¦„</div>
        <div id="sw-desc" style="font-size:14px; color:#7f8c8d; margin-top:5px;">ì„¤ëª…ë‚´ìš©</div>
        <div id="sw-info" style="font-size:13px; color:#34495e; margin-top:8px; font-weight:bold;">ë¹„ìš©: 0G | í™•ë¥ : 0%</div>
    </div>

    <div class="btn-group">
        <button onclick="handleUpgrade()" style="background:#2c3e50; color:white;">ê°•í™”í•˜ê¸°</button>
    </div>
</div>

<div class="rank-box" id="rank-box" style="display:none;">
    <h3 style="margin-top:0; font-size:16px; border-left:4px solid #2c3e50; padding-left:10px;">ğŸ† ì‹¤ì‹œê°„ ê³¨ë“œ ìˆœìœ„</h3>
    <div id="rank-list"></div>
</div>

<script>
    const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let user = null, swords = {};

    async function init() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) { location.href="login.html"; return; }
        
        const { data: s } = await supabaseClient.from('sword_data').select('*').order('level', { ascending: true });
        s.forEach(i => swords[i.level] = i);

        const { data: p } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
        user = p;
        
        document.getElementById('loading').style.display='none';
        document.getElementById('game-ui').style.display='block';
        document.getElementById('rank-box').style.display='block';
        
        updateUI();
        loadRanking();
    }

    function updateUI() {
        const s = swords[user.current_sword_lvl] || swords[1];
        document.getElementById('nick-display').innerText = user.nickname + "ë‹˜";
        document.getElementById('gold-display').innerText = user.gold.toLocaleString() + "G";
        document.getElementById('sw-name').innerText = `[+${s.level-1}] ${s.name}`;
        document.getElementById('sw-desc').innerText = s.description || "ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.";
        document.getElementById('sw-info').innerText = `ë¹„ìš©: ${s.upgrade_cost.toLocaleString()}G | í™•ë¥ : ${Math.floor(s.success_rate*100)}%`;
        document.getElementById('sword-img').src = s.image_url || "https://via.placeholder.com/200";
    }

    async function loadRanking() {
        const { data } = await supabaseClient.from('profiles').select('nickname, gold').order('gold', { ascending: false }).limit(5);
        const list = document.getElementById('rank-list');
        list.innerHTML = data.map((r, i) => `
            <div class="rank-item">
                <span><b>${i+1}ìœ„</b> ${r.nickname}</span>
                <span style="color:#27ae60">${r.gold.toLocaleString()}G</span>
            </div>
        `).join('');
    }

    async function handleUpgrade() {
        const s = swords[user.current_sword_lvl];
        if(user.gold < s.upgrade_cost) return alert("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");

        const img = document.getElementById('sword-img');
        img.classList.add('hammering');
        
        const success = Math.random() < s.success_rate;
        const nextLvl = success ? user.current_sword_lvl + 1 : user.current_sword_lvl;
        
        if(success && !swords[nextLvl]) {
            img.classList.remove('hammering');
            return alert("ì´ë¯¸ ìµœê³  ë‹¨ê³„ì…ë‹ˆë‹¤!");
        }

        const nextGold = user.gold - s.upgrade_cost;
        await supabaseClient.from('profiles').update({ gold: nextGold, current_sword_lvl: nextLvl }).eq('id', user.id);

        setTimeout(() => {
            img.classList.remove('hammering');
            user.gold = nextGold;
            user.current_sword_lvl = nextLvl;
            document.getElementById('npc-msg').innerText = success ? "ì„±ê³µì´ë¼ë„¤! ëŒ€ë‹¨í•˜êµ¬ë§Œ!" : "ì‹¤íŒ¨í–ˆêµ°... ë‹¤ì‹œ ë„ì „í•´ë³´ê²Œ.";
            updateUI();
            loadRanking();
        }, 800);
    }

    init();
</script>
</body>
</html>
