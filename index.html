<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>codetbase - í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ê°•í™”</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --main-red: #c0392b; --main-green: #27ae60; --dark-gray: #2c3e50; }
        body { background-color: #e6e9ed; font-family: 'Pretendard', sans-serif; display: flex; justify-content: center; margin: 0; padding: 20px 0; }
        .game-container { width: 100%; max-width: 420px; background: white; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; position: relative; display: none; }
        
        /* ìƒë‹¨ ì •ë³´ ë°” */
        .header-bar { background: var(--dark-gray); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .gold-box { position: relative; font-size: 18px; font-weight: bold; }
        
        /* ìºë¦­í„° ë§í’ì„  */
        .npc-talk { background: #f8f9fa; border: 1px solid #ddd; border-radius: 15px; margin: 15px; padding: 15px; text-align: left; }
        .npc-name { font-weight: bold; color: var(--main-red); margin-bottom: 5px; display: block; }
        .npc-msg { font-size: 14px; line-height: 1.5; color: #333; min-height: 40px; }

        /* ì´ë¯¸ì§€ ë°•ìŠ¤ */
        .image-box { background: #eee; height: 250px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; margin: 0 15px; border-radius: 20px; }
        .sword-img { max-width: 90%; max-height: 90%; object-fit: contain; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.1)); transition: 0.1s; }
        
        /* ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
        .shake { animation: shake 0.1s infinite; }
        @keyframes shake { 0% {transform: rotate(-2deg);} 50% {transform: rotate(2deg);} 100% {transform: rotate(-2deg);} }
        .money-effect { position: absolute; right: 0; top: 0; font-weight: bold; font-size: 24px; animation: floatUp 2.5s ease-out forwards; z-index: 100; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 0; } 10% { opacity: 1; } 100% { transform: translateY(-120px); opacity: 0; } }

        /* ì•„ì´í…œ ì •ë³´ ë° ë²„íŠ¼ */
        .item-info { padding: 15px; text-align: left; }
        .item-lvl-name { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .cost-row { font-size: 14px; color: #666; margin-top: 10px; display: flex; gap: 15px; }
        .btn-group { display: flex; gap: 10px; padding: 15px; }
        button { flex: 1; padding: 16px; border-radius: 15px; border: none; font-weight: bold; font-size: 18px; cursor: pointer; }
        .upgrade-btn { background: var(--dark-gray); color: white; }
        .sell-btn { background: #f1f2f6; color: #7f8c8d; }
    </style>
</head>
<body>

<div id="loading" style="margin-top: 100px;">ë°ì´í„° ë¡œë”© ì¤‘...</div>

<div class="game-container" id="game-ui">
    <div class="header-bar">
        <span id="nick-display" style="color:#f1c40f;">...ë‹˜</span>
        <div class="gold-box" id="gold-anchor">
            <span id="gold-display">0G</span>
        </div>
    </div>

    <div class="npc-talk">
        <span class="npc-name" id="npc-name">ëŒ€ì¥ì¥ì´ ë£¨ëŒí”„</span>
        <div class="npc-msg" id="npc-msg">"ì–´ì„œì˜¤ê²Œ! ì˜¤ëŠ˜ì€ ë¬´ì—‡ì„ ê°•í™”í•˜ëŸ¬ ì™”ë‚˜?"</div>
    </div>

    <div class="image-box">
        <img id="sword-img" src="" class="sword-img">
    </div>

    <div class="item-info">
        <div class="item-lvl-name" id="sw-name">ë¡œë”© ì¤‘...</div>
        <div class="item-desc" id="sw-desc" style="font-size: 14px; color: #666;">-</div>
        <div class="cost-row">
            <span>ğŸ’° ë¹„ìš©: <b id="u-cost">0</b>G</span>
            <span>ğŸ“ˆ í™•ë¥ : <b id="s-rate">0</b>%</span>
        </div>
    </div>

    <div class="btn-group">
        <button class="sell-btn" id="btn-sell" onclick="handleSell()">íŒë§¤</button>
        <button class="upgrade-btn" id="btn-upgrade" onclick="handleUpgrade()">ê°•í™”í•˜ê¸°</button>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let user = null, swords = {};

    async function init() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) { window.location.href = "login.html"; return; }

        const { data: sData } = await supabaseClient.from('sword_data').select('*');
        sData.forEach(s => swords[s.level] = s);

        const { data: pData } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
        user = pData;

        document.getElementById('loading').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        updateUI();
    }

    function updateUI() {
        if (!user || !swords[user.current_sword_lvl]) return;
        const s = swords[user.current_sword_lvl];

        document.getElementById('nick-display').innerText = `${user.nickname}ë‹˜`;
        document.getElementById('gold-display').innerText = `${user.gold.toLocaleString()}G`;
        document.getElementById('sw-name').innerText = `[+${user.current_sword_lvl - 1}] ${s.name}`;
        document.getElementById('sw-desc').innerText = s.description;
        document.getElementById('u-cost').innerText = s.upgrade_cost.toLocaleString();
        document.getElementById('s-rate').innerText = Math.floor(s.success_rate * 100);

        // [í•µì‹¬] ê´€ë¦¬ìì—ì„œ ì„¤ì •í•œ ì´ë¯¸ì§€ URL ì ìš©
        const imgTag = document.getElementById('sword-img');
        imgTag.src = s.image_url || "https://cdn-icons-png.flaticon.com/512/3233/3233514.png";
    }

    function animateMoney(amount, type) {
        const anchor = document.getElementById('gold-anchor');
        const effect = document.createElement('div');
        effect.className = 'money-effect';
        effect.style.color = (type === 'minus') ? '#e74c3c' : '#3498db';
        effect.innerText = (type === 'minus' ? '-' : '+') + amount.toLocaleString() + 'G';
        anchor.appendChild(effect);
        setTimeout(() => effect.remove(), 2500);
    }

    async function handleUpgrade() {
        const s = swords[user.current_sword_lvl];
        if (user.gold < s.upgrade_cost) {
            document.getElementById('npc-msg').innerText = "ëŒ€ì¥ì¥ì´: ê³¨ë“œê°€ ë¶€ì¡±í•˜êµ¬ë§Œ. ë” ë²Œì–´ì˜¤ê²Œ!";
            return;
        }

        const img = document.getElementById('sword-img');
        img.classList.add('shake');
        animateMoney(s.upgrade_cost, 'minus');

        const success = Math.random() < s.success_rate;
        // ì‹¤íŒ¨ ì‹œ ë ˆë²¨ ìœ ì§€ ë¡œì§ (ë³´ë‚´ì£¼ì‹  ì´ë¯¸ì§€ ëª¨í‹°ë¸Œ)
        const nextLvl = success ? user.current_sword_lvl + 1 : user.current_sword_lvl; 
        const nextGold = user.gold - s.upgrade_cost;

        await supabaseClient.from('profiles').update({ gold: nextGold, current_sword_lvl: nextLvl }).eq('id', user.id);

        setTimeout(() => {
            img.classList.remove('shake');
            user.gold = nextGold; user.current_sword_lvl = nextLvl;
            document.getElementById('npc-msg').innerText = success ? "ì„±ê³µ! ì œë²• ë‚ ì¹´ë¡œì›Œì¡Œêµ°." : "ì•„ê¹êµ°! ë ˆë²¨ì´ ìœ ì§€ë˜ì—ˆë„¤.";
            updateUI();
        }, 600);
    }

    async function handleSell() {
        const s = swords[user.current_sword_lvl];
        const nextGold = user.gold + s.sell_price;
        await supabaseClient.from('profiles').update({ gold: nextGold, current_sword_lvl: 1 }).eq('id', user.id);
        animateMoney(s.sell_price, 'plus');
        user.gold = nextGold; user.current_sword_lvl = 1;
        document.getElementById('npc-name').innerText = "ëˆˆì‚¬ëŒ ê°ì •ì‚¬";
        document.getElementById('npc-msg').innerText = `"ì¢‹ì€ ê±°ë˜ì˜€ë„¤! ì—¬ê¸° ${s.sell_price}G ì¼ì„¸."`;
        updateUI();
    }

    function handleLogout() { supabaseClient.auth.signOut(); window.location.href = "login.html"; }

    init();
</script>
</body>
</html>
