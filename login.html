<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>검 강화 게임 - 로그인</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #e6e9ed; font-family: 'Pretendard', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .login-box { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 350px; }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 25px; }
        input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 14px; }
        button { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-bottom: 10px; transition: 0.2s; }
        .btn-login { background: #2c3e50; color: white; }
        .btn-login:hover { background: #1a252f; }
        .btn-join { background: #f1f2f6; color: #2c3e50; }
        .btn-join:hover { background: #e2e4e9; }
        .info-text { font-size: 12px; color: #7f8c8d; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

<div class="login-box">
    <h2>⚔️ 검 강화 게임</h2>
    
    <input type="tel" id="phone" placeholder="전화번호 (숫자만 입력)" maxlength="11">
    
    <input type="password" id="pw" placeholder="비밀번호 (6자 이상)">
    
    <input type="text" id="nick" placeholder="닉네임" style="display: none;">
    
    <button class="btn-login" id="main-btn" onclick="handleAuth()">로그인</button>
    <button class="btn-join" id="sub-btn" onclick="toggleMode()">계정 만들기</button>
    
    <div class="info-text" id="mode-desc">아이디 대신 전화번호를 사용합니다.</div>
</div>

<script>
    const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let isJoinMode = false;

    // 회원가입/로그인 모드 전환
    function toggleMode() {
        isJoinMode = !isJoinMode;
        document.getElementById('nick').style.display = isJoinMode ? 'block' : 'none';
        document.getElementById('main-btn').innerText = isJoinMode ? '회원가입' : '로그인';
        document.getElementById('sub-btn').innerText = isJoinMode ? '로그인하러 가기' : '계정 만들기';
        document.getElementById('mode-desc').innerText = isJoinMode ? "회원정보를 입력해주세요." : "아이디 대신 전화번호를 사용합니다.";
    }

    async function handleAuth() {
        const phone = document.getElementById('phone').value.trim().replace(/[^0-9]/g, "");
        const pw = document.getElementById('pw').value;
        const nick = document.getElementById('nick').value.trim();

        if(!phone || phone.length < 10) return alert("올바른 전화번호를 입력하세요.");
        if(pw.length < 6) return alert("비밀번호는 6자리 이상이어야 합니다.");

        // 전화번호를 이메일 주소 형태로 변환 (Supabase Auth 호환용)
        const userIdentifier = `${phone}@phone.game`;

        if (isJoinMode) {
            if(!nick) return alert("닉네임을 입력하세요.");
            
            // 1. 회원가입 시도
            const { data, error } = await supabaseClient.auth.signUp({ 
                email: userIdentifier, 
                password: pw 
            });

            if (error) return alert("가입 실패: " + error.message);
            if (!data.user) return alert("가입 처리 중 오류가 발생했습니다.");

            // 2. 프로필 DB 생성 (기본 골드 10000, 1레벨 검 세팅)
            const { error: profileError } = await supabaseClient.from('profiles').insert([
                { 
                    id: data.user.id, 
                    nickname: nick, 
                    gold: 10000, 
                    current_sword_lvl: 1 
                }
            ]);

            if (profileError) {
                console.error(profileError);
                return alert("프로필 생성 오류: " + profileError.message);
            }

            alert("회원가입 성공! 이제 로그인을 해주세요.");
            toggleMode();
        } else {
            // 로그인 시도
            const { data, error } = await supabaseClient.auth.signInWithPassword({ 
                email: userIdentifier, 
                password: pw 
            });

            if (error) return alert("로그인 실패: 번호 또는 비밀번호를 확인하세요.");
            
            // 로그인 성공 시 메인 게임 화면으로 이동
            location.href = "index.html";
        }
    }
</script>
</body>
</html>
