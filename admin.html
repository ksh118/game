<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>codetbase - í†µí•© ì–´ë“œë¯¼</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .admin-box { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1 { font-size: 24px; text-align: center; color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        
        .section { margin-top: 30px; padding: 15px; border: 1px solid #eee; border-radius: 15px; background: #fff; }
        .section-title { font-weight: 900; margin-bottom: 15px; display: block; color: #2c3e50; font-size: 18px; border-left: 5px solid #2c3e50; padding-left: 10px; }

        input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; font-size: 14px; }
        .btn { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-save { background: #2c3e50; color: white; width: 100%; }
        .btn-refresh { background: #3498db; color: white; margin-bottom: 10px; }
        .btn-add { background: #2ecc71; color: white; width: 100%; margin-top: 5px; }

        /* í…Œì´ë¸” ê³µí†µ ìŠ¤íƒ€ì¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; table-layout: fixed; }
        th, td { border: 1px solid #eee; padding: 8px; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        th { background: #f8f9fa; }
        
        .sword-edit-input { width: 100%; border: 1px solid #ccc; padding: 4px; border-radius: 4px; font-size: 12px; }
        .ban-btn { background: #e74c3c; color: white; border-radius: 5px; cursor: pointer; padding: 5px; border: none; }
        .unban-btn { background: #2ecc71; color: white; border-radius: 5px; cursor: pointer; padding: 5px; border: none; }
        .del-btn { background: #95a5a6; color: white; border-radius: 5px; cursor: pointer; padding: 5px; border: none; }
    </style>
</head>
<body>

<div class="admin-box">
    <h1>ğŸ›¡ï¸ codetbase í†µí•© ì–´ë“œë¯¼</h1>

    <div class="section">
        <span class="section-title">âš”ï¸ ê²€ ë°ì´í„° ê´€ë¦¬</span>
        <button class="btn btn-refresh" onclick="loadSwordData()">ê²€ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°/ìƒˆë¡œê³ ì¹¨</button>
        <div style="overflow-x: auto;">
            <table id="sword-table">
                <thead>
                    <tr>
                        <th width="40">LV</th>
                        <th width="100">ì´ë¦„</th>
                        <th width="70">í™•ë¥ </th>
                        <th width="80">ê°•í™”ë¹„ìš©</th>
                        <th width="80">íŒë§¤ê¸ˆì•¡</th>
                        <th width="150">ì´ë¯¸ì§€URL</th>
                        <th width="60">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="sword-table-body"></tbody>
            </table>
        </div>
    </div>

    <div class="section">
        <span class="section-title">ğŸ ë³´ìƒ ì½”ë“œ(ì¿ í°) ê´€ë¦¬</span>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <input type="text" id="new-code-name" placeholder="ì½”ë“œëª… (ì˜ˆ: ì˜¤í”ˆê¸°ë…)">
            <input type="number" id="new-code-reward" placeholder="ë³´ìƒ ê³¨ë“œëŸ‰">
        </div>
        <button class="btn btn-add" onclick="addRewardCode()">ì‹ ê·œ ì½”ë“œ ìƒì„±</button>
        <div style="overflow-x: auto; margin-top: 15px;">
            <table>
                <thead>
                    <tr>
                        <th>ì½”ë“œëª…</th>
                        <th>ë³´ìƒ ê³¨ë“œ</th>
                        <th>ìƒì„±ì¼</th>
                        <th>ì‚­ì œ</th>
                    </tr>
                </thead>
                <tbody id="code-table-body"></tbody>
            </table>
        </div>
    </div>

    <div class="section">
        <span class="section-title">âš™ï¸ ì¶œì„ ë³´ìƒ ì„¤ì •</span>
        <input type="number" id="daily-reward-input" placeholder="ì¶œì„ ë³´ìƒ ê¸ˆì•¡ ì…ë ¥">
        <button class="btn btn-save" onclick="saveDailySetting()">ë³´ìƒ ê¸ˆì•¡ ì €ì¥</button>
    </div>

    <div class="section">
        <span class="section-title">ğŸ‘¥ ìœ ì € ì •ì§€ ê´€ë¦¬</span>
        <button class="btn btn-refresh" onclick="loadUserList()">ìœ ì € ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>ë‹‰ë„¤ì„</th>
                        <th>ê³¨ë“œ</th>
                        <th>ìƒíƒœ</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="user-table-body"></tbody>
            </table>
        </div>
    </div>

    <button onclick="location.href='index.html'" style="width: 100%; background: none; border: none; color: #888; margin-top: 20px; cursor: pointer;">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
</div>

<script>
    const SUPABASE_URL = 'https://utfrjzcnefsbuadnkdud.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function init() {
        loadSwordData();
        loadRewardCodes();
        loadUserList();
        document.getElementById('daily-reward-input').value = localStorage.getItem('codet_daily') || 5000;
    }

    // --- ê²€ ë°ì´í„° ë¡œì§ ---
    async function loadSwordData() {
        const { data, error } = await supabaseClient.from('sword_data').select('*').order('level', { ascending: true });
        const tbody = document.getElementById('sword-table-body');
        tbody.innerHTML = "";
        data.forEach(s => {
            tbody.innerHTML += `
                <tr>
                    <td>${s.level}</td>
                    <td><input type="text" class="sword-edit-input" id="name-${s.level}" value="${s.name}"></td>
                    <td><input type="number" step="0.01" class="sword-edit-input" id="rate-${s.level}" value="${s.success_rate}"></td>
                    <td><input type="number" class="sword-edit-input" id="cost-${s.level}" value="${s.upgrade_cost}"></td>
                    <td><input type="number" class="sword-edit-input" id="sell-${s.level}" value="${s.sell_price || 0}"></td>
                    <td><input type="text" class="sword-edit-input" id="img-${s.level}" value="${s.image_url}"></td>
                    <td><button onclick="updateSword(${s.level})" style="cursor:pointer;">ì €ì¥</button></td>
                </tr>`;
        });
    }

    async function updateSword(lvl) {
        const updateData = {
            name: document.getElementById(`name-${lvl}`).value,
            success_rate: parseFloat(document.getElementById(`rate-${lvl}`).value),
            upgrade_cost: parseInt(document.getElementById(`cost-${lvl}`).value),
            sell_price: parseInt(document.getElementById(`sell-${lvl}`).value),
            image_url: document.getElementById(`img-${lvl}`).value
        };
        const { error } = await supabaseClient.from('sword_data').update(updateData).eq('level', lvl);
        if (error) alert("ì‹¤íŒ¨: " + error.message); else alert(lvl + "LV ì €ì¥ ì™„ë£Œ!");
    }

    // --- ë³´ìƒ ì½”ë“œ ë¡œì§ ---
    async function loadRewardCodes() {
        const { data, error } = await supabaseClient.from('reward_codes').select('*').order('created_at', { ascending: false });
        const tbody = document.getElementById('code-table-body');
        tbody.innerHTML = "";
        data.forEach(c => {
            tbody.innerHTML += `
                <tr>
                    <td><b>${c.code}</b></td>
                    <td>${c.reward_gold.toLocaleString()}G</td>
                    <td>${new Date(c.created_at).toLocaleDateString()}</td>
                    <td><button class="del-btn" onclick="deleteCode('${c.code}')">ì‚­ì œ</button></td>
                </tr>`;
        });
    }

    async function addRewardCode() {
        const code = document.getElementById('new-code-name').value.trim();
        const reward = parseInt(document.getElementById('new-code-reward').value);
        if(!code || !reward) return alert("ì½”ë“œëª…ê³¼ ë³´ìƒ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.");

        const { error } = await supabaseClient.from('reward_codes').insert([{ code: code, reward_gold: reward }]);
        if(error) alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì½”ë“œì´ê±°ë‚˜ ìƒì„± ì‹¤íŒ¨");
        else { alert("ë³´ìƒ ì½”ë“œ ìƒì„± ì™„ë£Œ!"); loadRewardCodes(); }
    }

    async function deleteCode(code) {
        if(!confirm("ì½”ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        await supabaseClient.from('reward_codes').delete().eq('code', code);
        loadRewardCodes();
    }

    // --- ê¸°íƒ€ ë¡œì§ (ì¶œì„/ìœ ì €) ---
    function saveDailySetting() {
        localStorage.setItem('codet_daily', document.getElementById('daily-reward-input').value);
        alert("ì¶œì„ ë³´ìƒ ì„¤ì • ì™„ë£Œ!");
    }

    async function loadUserList() {
        const { data } = await supabaseClient.from('profiles').select('*').order('gold', { ascending: false });
        const tbody = document.getElementById('user-table-body');
        tbody.innerHTML = "";
        data.forEach(user => {
            const isBanned = user.is_banned === true;
            tbody.innerHTML += `
                <tr>
                    <td>${user.nickname}</td>
                    <td>${user.gold.toLocaleString()}G</td>
                    <td style="color:${isBanned?'red':'green'}">${isBanned?'ì •ì§€':'ì •ìƒ'}</td>
                    <td><button class="${isBanned?'unban-btn':'ban-btn'}" onclick="toggleBan('${user.id}', ${!isBanned})">${isBanned?'í•´ì œ':'ì •ì§€'}</button></td>
                </tr>`;
        });
    }

    async function toggleBan(uid, status) {
        await supabaseClient.from('profiles').update({ is_banned: status }).eq('id', uid);
        loadUserList();
    }

    init();
</script>
</body>
</html>
